{% extends "base.html" %}

{% block title %}–í—Å–µ –ø–µ—Å–Ω–∏ - LinguaTune{% endblock %}

{% block content %}
<h2>üé∂ –í—Å–µ –ø–µ—Å–Ω–∏ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è</h2>

{% if not user_email %}
<div class="alert alert-warning">
    ‚ö†Ô∏è –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –æ—Ç–º–µ—á–∞—Ç—å –ø–µ—Å–Ω–∏ –∫–∞–∫ –∏–∑—É—á–µ–Ω–Ω—ã–µ
</div>
{% endif %}

{% for song in songs %}
<div class="song-card" id="song-{{ song.id }}" {% if song.id in learned_song_ids %}style="background: #e8f5e8;"{% endif %}>
    <div class="song-title">
        {{ song.title }}
        {% if song.id in learned_song_ids %} ‚úÖ{% endif %}
    </div>
    <div class="song-artist">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {{ song.artist }}</div>
    <div>
        <span class="language-badge">
            {% if song.language == 'en' %}üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π
            {% elif song.language == 'es' %}üá™üá∏ –ò—Å–ø–∞–Ω—Å–∫–∏–π
            {% elif song.language == 'fr' %}üá´üá∑ –§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π
            {% elif song.language == 'de' %}üá©üá™ –ù–µ–º–µ—Ü–∫–∏–π
            {% else %}{{ song.language }}{% endif %}
        </span>
        <span class="difficulty-{{ song.difficulty }}">
            –£—Ä–æ–≤–µ–Ω—å: 
            {% if song.difficulty == 'beginner' %}–ù–∞—á–∞–ª—å–Ω—ã–π
            {% elif song.difficulty == 'intermediate' %}–°—Ä–µ–¥–Ω–∏–π
            {% elif song.difficulty == 'advanced' %}–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
            {% else %}{{ song.difficulty }}{% endif %}
        </span>
    </div>
    <div style="margin-top: 10px;">
        <strong>–¢–µ–∫—Å—Ç:</strong><br>
        {{ song.lyrics_original[:100] }}...
    </div>
    <div style="margin-top: 5px;">
        <strong>–ü–µ—Ä–µ–≤–æ–¥:</strong><br>
        {{ song.lyrics_translation[:100] }}...
    </div>
    <div style="margin-top: 10px;">
        {% if user_email %}
            {% if song.id not in learned_song_ids %}
                <button onclick="markAsLearned({{ song.id }})" class="btn">‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –∏–∑—É—á–µ–Ω–Ω–æ–π</button>
            {% else %}
                <button onclick="unmarkAsLearned({{ song.id }})" class="btn btn-danger">‚ùå –£–±—Ä–∞—Ç—å –æ—Ç–º–µ—Ç–∫—É</button>
            {% endif %}
        {% else %}
            <button class="btn" disabled title="–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ç–º–µ—á–∞—Ç—å –ø–µ—Å–Ω–∏">‚úÖ –ò–∑—É—á–µ–Ω–æ</button>
        {% endif %}
        <a href="/song/{{ song.id }}" class="btn">üìñ –ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
    </div>
</div>
{% endfor %}

{% if user_email %}
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø–µ—Å–Ω–∏ –∫–∞–∫ –∏–∑—É—á–µ–Ω–Ω–æ–π
async function markAsLearned(songId) {
    try {
        const response = await fetch(`/progress/user/{{ user_email }}/learned/${songId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–∞—Ä—Ç–æ—á–∫–∏
            const songCard = document.getElementById(`song-${songId}`);
            songCard.style.background = '#e8f5e8';
            
            // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É
            const button = songCard.querySelector('button');
            button.textContent = '‚ùå –£–±—Ä–∞—Ç—å –æ—Ç–º–µ—Ç–∫—É';
            button.className = 'btn btn-danger';
            button.onclick = () => unmarkAsLearned(songId);
            
            alert(result.message || '–ü–µ—Å–Ω—è –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∏–∑—É—á–µ–Ω–Ω–∞—è!');
        } else {
            alert(`–û—à–∏–±–∫–∞: ${result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–±–∏—Ä–∞–Ω–∏—è –æ—Ç–º–µ—Ç–∫–∏
async function unmarkAsLearned(songId) {
    if (!confirm('–£–±—Ä–∞—Ç—å –ø–µ—Å–Ω—é –∏–∑ –∏–∑—É—á–µ–Ω–Ω—ã—Ö?')) {
        return;
    }
    
    try {
        const response = await fetch(`/progress/user/{{ user_email }}/learned/${songId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–∞—Ä—Ç–æ—á–∫–∏
            const songCard = document.getElementById(`song-${songId}`);
            songCard.style.background = '';
            
            // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É
            const button = songCard.querySelector('button');
            button.textContent = '‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –∏–∑—É—á–µ–Ω–Ω–æ–π';
            button.className = 'btn';
            button.onclick = () => markAsLearned(songId);
            
            alert(result.message || '–ü–µ—Å–Ω—è —É–±—Ä–∞–Ω–∞ –∏–∑ –∏–∑—É—á–µ–Ω–Ω—ã—Ö!');
        } else {
            alert(`–û—à–∏–±–∫–∞: ${result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    }
}
</script>
{% endif %}
{% endblock %}